<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>แอดมิน — ระบบบันทึกเวลา (โทนฟ้าอ่อน)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{box-sizing:border-box}
    .fade-in{animation:fadeIn .5s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .btn{position:relative;overflow:hidden}
    .btn::after{content:"";position:absolute;inset:auto auto -120% -120%;width:240%;height:240%;
      background:radial-gradient(transparent 40%,rgba(255,255,255,.25) 41%);transform:rotate(25deg);transition:all .5s ease;}
    .btn:hover::after{inset:auto auto -80% -80%}
    @media print{.no-print{display:none!important}.print-only{display:block!important}}
    .print-only{display:none}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-sky-50 via-blue-50 to-sky-100 text-gray-700">

  <!-- Topbar -->
  <header class="no-print sticky top-0 z-30 backdrop-blur bg-white/50 border-b border-sky-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-gradient-to-br from-sky-400 to-blue-500 shadow-lg flex items-center justify-center text-white font-bold">TL</div>
        <div class="leading-tight">
          <div class="font-bold text-sky-800">TimeLog Admin</div>
          <div class="text-xs text-sky-600">จัดการพนักงาน & รายงาน</div>
        </div>
      </div>
      <nav class="text-sm">
        <a href="index.html" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/70 hover:bg-white text-sky-700 border border-sky-100 shadow-sm transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M3 12l7-7v4h7v6h-7v4l-7-7z" stroke="#0369a1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          หน้าบ้าน
        </a>
      </nav>
    </div>
  </header>

  <!-- Hero / Head -->
  <section class="relative">
    <div class="pointer-events-none absolute inset-0">
      <svg class="opacity-30" width="100%" height="100%">
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#bae6fd"/>
            <stop offset="100%" stop-color="#e0f2fe"/>
          </linearGradient>
        </defs>
        <circle cx="8%" cy="18%" r="120" fill="url(#g1)"/>
        <circle cx="92%" cy="12%" r="80" fill="#bfdbfe"/>
        <circle cx="85%" cy="85%" r="140" fill="#e0f2fe"/>
      </svg>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-10 md:py-14 relative">
      <div class="grid md:grid-cols-2 gap-7 items-start">
        <div class="fade-in">
          <h1 class="text-3xl md:text-4xl font-extrabold text-sky-900 leading-tight">
            แผงควบคุมแอดมิน<br class="hidden md:block" />
            <span class="bg-gradient-to-r from-sky-500 to-blue-600 bg-clip-text text-transparent">จัดการพนักงาน & ดูสรุปรายเดือน</span>
          </h1>
          <p class="mt-3 text-sky-700/80">
            แก้ไขรายชื่อพนักงาน คิดชั่วโมงรวมแบบจับคู่ IN→OUT อัตโนมัติ, Export CSV, พิมพ์รายงาน และล้างข้อมูลได้จากที่นี่
          </p>
          <div class="mt-5 grid grid-cols-2 gap-4">
            <div class="rounded-2xl p-4 bg-white/70 backdrop-blur border border-sky-100 shadow-sm">
              <div class="text-xs text-sky-600">พนักงานทั้งหมด</div>
              <div id="statEmployees" class="text-2xl font-bold text-sky-900">0</div>
            </div>
            <div class="rounded-2xl p-4 bg-white/70 backdrop-blur border border-sky-100 shadow-sm">
              <div class="text-xs text-sky-600">บันทึกทั้งหมด</div>
              <div id="statRecords" class="text-2xl font-bold text-sky-900">0</div>
            </div>
          </div>
        </div>

        <!-- Controls Card -->
        <div class="fade-in rounded-3xl bg-white/80 backdrop-blur border border-sky-100 shadow-xl p-6">
          <h2 class="text-lg font-semibold text-sky-900 mb-4">จัดการพนักงาน & การคำนวณ</h2>
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2 text-sky-900">ชื่อ-สกุล</label>
              <input id="employeeName" class="w-full px-3 py-2 rounded-xl border border-sky-200 focus:outline-none focus:ring-2 focus:ring-sky-300" placeholder="กรอกชื่อ-สกุล" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-2 text-sky-900">เงินเดือน/เดือน (บาท)</label>
              <input id="monthlySalary" type="number" min="0" class="w-full px-3 py-2 rounded-xl border border-sky-200 focus:outline-none focus:ring-2 focus:ring-sky-300" placeholder="เช่น 18000" />
            </div>
            <div class="flex items-end">
              <button id="addEmpBtn" class="btn w-full bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-xl shadow">เพิ่มพนักงาน</button>
            </div>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2 text-sky-900">ชั่วโมงทำงานมาตรฐาน/วัน</label>
              <input id="hoursPerDay" type="number" min="1" value="8" class="w-36 px-3 py-2 rounded-xl border border-sky-200 focus:outline-none focus:ring-2 focus:ring-sky-300" />
              <p class="text-xs text-sky-700/70 mt-1">ค่าแรง/ชั่วโมง ≈ เงินเดือน ÷ (30 × ชั่วโมง/วัน)</p>
            </div>
            <div class="flex items-end gap-2">
              <button id="exportCsvBtn" class="btn bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl shadow">Export CSV</button>
              <button id="printBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow">พิมพ์รายงาน</button>
              <button id="clearAllBtn" class="btn bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-xl shadow">ล้างข้อมูล</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FILTERS (ใหม่) -->
  <section class="max-w-6xl mx-auto px-4">
    <div class="rounded-3xl bg-white/80 backdrop-blur border border-sky-100 shadow-xl p-6 mb-6">
      <h3 class="text-lg font-semibold text-sky-900 mb-3">ตัวกรองข้อมูล</h3>
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2 text-sky-900">ค้นหาชื่อพนักงาน</label>
          <input id="searchName" class="w-full px-3 py-2 rounded-xl border border-sky-200 focus:outline-none focus:ring-2 focus:ring-sky-300" placeholder="พิมพ์บางส่วนของชื่อ..." />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-sky-900">กรองประเภทบันทึก</label>
          <select id="filterType" class="w-full px-3 py-2 rounded-xl border border-sky-200 focus:outline-none focus:ring-2 focus:ring-sky-300">
            <option value="all">ทั้งหมด</option>
            <option value="in">เฉพาะเข้างาน (IN)</option>
            <option value="out">เฉพาะออกงาน (OUT)</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="clearFilterBtn" class="btn w-full bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-xl shadow">ล้างตัวกรอง</button>
        </div>
      </div>
      <p class="mt-3 text-xs text-sky-700/70">* การค้นหาชื่อมีผลทั้ง “ตารางพนักงาน” และ “ตารางบันทึกเวลา”; การกรองประเภทมีผลกับ “ตารางบันทึกเวลา”</p>
    </div>
  </section>

  <!-- Employee Table -->
  <section class="max-w-6xl mx-auto px-4">
    <div class="rounded-3xl bg-white/80 backdrop-blur border border-sky-100 shadow-xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-sky-900">พนักงาน & สรุปรายเดือน (เดือนปัจจุบัน)</h3>
        <span id="empCountShown" class="text-xs text-sky-600"></span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full table-auto">
          <thead>
            <tr class="bg-sky-50/70 text-sky-900">
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">#</th>
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">ชื่อ-สกุล</th>
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">เงินเดือน</th>
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">ชั่วโมงรวม</th>
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">เงินที่ได้รับ (≈)</th>
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium no-print">จัดการ</th>
            </tr>
          </thead>
          <tbody id="employeeTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Records Table -->
  <section class="max-w-6xl mx-auto px-4 pb-14">
    <div class="rounded-3xl bg-white/80 backdrop-blur border border-sky-100 shadow-xl p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold text-sky-900">บันทึกเวลา (ใหม่สุดก่อน)</h3>
        <span id="recCountShown" class="text-xs text-sky-600"></span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full table-auto">
          <thead>
            <tr class="bg-sky-50/70 text-sky-900">
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">วันที่</th>
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">เวลา</th>
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">ชื่อ-สกุล</th>
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">ประเภท</th>
              <th class="px-4 py-3 text-left text-xs md:text-sm font-medium">รูปภาพ</th>
            </tr>
          </thead>
          <tbody id="timeRecordsBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Print Header -->
  <div class="print-only">
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold">รายงานการทำงานประจำเดือน</h1>
      <p class="text-gray-600">วันที่พิมพ์: <span id="printDate"></span></p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="no-print border-t border-sky-100 bg-white/70 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-4 text-xs text-sky-700 flex items-center justify-between">
      <span>© <span id="year"></span> TimeLog — Admin</span>
      <span>ทำงานบนเบราว์เซอร์ (localStorage)</span>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl text-white text-sm shadow-lg hidden"></div>

  <script>
    // ---------- PIN ----------
    const ADMIN_PIN = '2468'; // แก้ PIN ได้ที่นี่
    (function requirePin(){
      const fromQuery = new URLSearchParams(location.search).get('pin');
      const pin = fromQuery || prompt('กรุณาใส่ PIN หลังบ้าน:');
      if(pin !== ADMIN_PIN){ alert('PIN ไม่ถูกต้อง'); location.href='index.html'; }
    })();

    // ---------- STATE ----------
    let employees = JSON.parse(localStorage.getItem('employees')) || [];
    let timeRecords = JSON.parse(localStorage.getItem('timeRecords')) || [];

    // Filters state
    let filterName = '';
    let filterType = 'all'; // all | in | out

    document.addEventListener('DOMContentLoaded', ()=>{
      bindButtons();
      renderAll();
      document.getElementById('year').textContent = new Date().getFullYear();
      updateStats();
    });

    function bindButtons(){
      document.getElementById('addEmpBtn').addEventListener('click', addEmployee);
      document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);
      document.getElementById('printBtn').addEventListener('click', printReport);
      document.getElementById('clearAllBtn').addEventListener('click', clearAllData);
      document.getElementById('hoursPerDay').addEventListener('change', renderAll);

      // filters
      const nameInput = document.getElementById('searchName');
      const typeSelect = document.getElementById('filterType');
      const clearBtn = document.getElementById('clearFilterBtn');

      // debounce ค้นหา
      let t;
      nameInput.addEventListener('input', e=>{
        clearTimeout(t);
        t = setTimeout(()=>{ filterName = e.target.value.trim().toLowerCase(); renderAll(); }, 180);
      });
      typeSelect.addEventListener('change', e=>{
        filterType = e.target.value;
        renderAll();
      });
      clearBtn.addEventListener('click', ()=>{
        document.getElementById('searchName').value='';
        document.getElementById('filterType').value='all';
        filterName=''; filterType='all';
        renderAll();
      });
    }

    function saveEmployees(){ localStorage.setItem('employees', JSON.stringify(employees)); }
    function saveRecords(){ localStorage.setItem('timeRecords', JSON.stringify(timeRecords)); }

    // ---------- STATS ----------
    function updateStats(){
      document.getElementById('statEmployees').textContent = employees.length;
      document.getElementById('statRecords').textContent = timeRecords.length;
    }

    // ---------- EMPLOYEES ----------
    function addEmployee(){
      const name = document.getElementById('employeeName').value.trim();
      const salary = parseFloat(document.getElementById('monthlySalary').value);
      if(!name || !salary || salary<=0){
        showToast('กรุณากรอกข้อมูลพนักงานให้ถูกต้อง', true); return;
      }
      employees.push({id: Date.now(), name, monthlySalary: salary});
      saveEmployees();
      document.getElementById('employeeName').value='';
      document.getElementById('monthlySalary').value='';
      renderAll();
      updateStats();
      showToast('เพิ่มพนักงานเรียบร้อย');
    }

    function deleteEmployee(id){
      if(!confirm('ลบพนักงานและบันทึกเวลาที่เกี่ยวข้องทั้งหมด?')) return;
      employees = employees.filter(e=>e.id!==id);
      timeRecords = timeRecords.filter(r=>r.employeeId!==id);
      saveEmployees(); saveRecords();
      renderAll();
      updateStats();
      showToast('ลบพนักงานเรียบร้อย');
    }

    // ---------- AGGREGATION ----------
    function getMonthHoursForEmp(empId){
      const now = new Date();
      const m = now.getMonth(), y = now.getFullYear();
      const recs = timeRecords
        .filter(r=>r.employeeId===empId)
        .filter(r=>{ const d=new Date(r.timestamp); return d.getMonth()===m && d.getFullYear()===y; })
        .sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
      let totalMs = 0, openIn = null;
      const sameDay = (a,b)=> a.toDateString()===b.toDateString();
      recs.forEach(r=>{
        const d = new Date(r.timestamp);
        if(r.type==='in'){
          if(openIn && !sameDay(new Date(openIn.timestamp), d)) openIn=null;
          openIn = r;
        }else if(r.type==='out' && openIn){
          const dIn = new Date(openIn.timestamp);
          if(sameDay(dIn,d) && d>dIn){ totalMs += (d-dIn); openIn=null; }
        }
      });
      return totalMs/(1000*60*60); // ชม.
    }

    // ---------- RENDER ----------
    function renderEmployeesTable(){
      const hrsPerDay = Math.max(1, parseFloat(document.getElementById('hoursPerDay').value) || 8);
      const tb = document.getElementById('employeeTableBody');
      tb.innerHTML='';

      const list = employees
        .filter(e => !filterName || e.name.toLowerCase().includes(filterName));

      list.forEach((e,i)=>{
        const hours = getMonthHoursForEmp(e.id);
        const hourlyRate = e.monthlySalary / (30*hrsPerDay);
        const earned = hours * hourlyRate;
        const tr=document.createElement('tr');
        tr.className='border-b border-sky-100 hover:bg-sky-50/50';
        tr.innerHTML = `
          <td class="px-4 py-3 text-xs md:text-sm">${i+1}</td>
          <td class="px-4 py-3 text-xs md:text-sm">${e.name}</td>
          <td class="px-4 py-3 text-xs md:text-sm">${e.monthlySalary.toLocaleString()} บาท</td>
          <td class="px-4 py-3 text-xs md:text-sm">${hours.toFixed(2)} ชม.</td>
          <td class="px-4 py-3 text-xs md:text-sm font-semibold text-emerald-700">${earned.toLocaleString('th-TH',{maximumFractionDigits:2})} บาท</td>
          <td class="px-4 py-3 text-xs md:text-sm no-print">
            <button class="btn bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 rounded-lg" onclick="deleteEmployee(${e.id})">ลบ</button>
          </td>
        `;
        tb.appendChild(tr);
      });

      document.getElementById('empCountShown').textContent =
        `แสดง ${list.length} / ทั้งหมด ${employees.length} คน`;
    }

    function renderRecordsTable(){
      const tb = document.getElementById('timeRecordsBody');
      tb.innerHTML='';

      const sorted = [...timeRecords].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));

      const list = sorted.filter(r=>{
        const byName = !filterName || r.employeeName.toLowerCase().includes(filterName);
        const byType = (filterType==='all') || r.type===filterType;
        return byName && byType;
      });

      list.forEach(r=>{
        const d=new Date(r.timestamp);
        const typeText=r.type==='in'?'เข้างาน':'ออกงาน';
        const typeClass=r.type==='in'?'text-emerald-700 bg-emerald-50':'text-rose-700 bg-rose-50';
        const tr=document.createElement('tr');
        tr.className='border-b border-sky-100 hover:bg-sky-50/50';
        tr.innerHTML=`
          <td class="px-4 py-3 text-xs md:text-sm">${d.toLocaleDateString('th-TH')}</td>
          <td class="px-4 py-3 text-xs md:text-sm">${d.toLocaleTimeString('th-TH')}</td>
          <td class="px-4 py-3 text-xs md:text-sm">${r.employeeName}</td>
          <td class="px-4 py-3">
            <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-semibold ${typeClass}">
              ${typeText}
            </span>
          </td>
          <td class="px-4 py-3 text-xs md:text-sm"><img src="${r.photo}" class="w-12 h-9 rounded-lg border border-sky-200 shadow-sm bg-white"/></td>
        `;
        tb.appendChild(tr);
      });

      document.getElementById('recCountShown').textContent =
        `แสดง ${list.length} รายการ (ทั้งหมด ${timeRecords.length})`;
    }

    function renderAll(){
      renderEmployeesTable();
      renderRecordsTable();
    }

    // ---------- ACTIONS ----------
    function exportCSV(){
      const rows = [['id','employeeId','employeeName','type','timestamp','photoDataUrl']];
      timeRecords.forEach(r=>rows.push([r.id, r.employeeId, r.employeeName, r.type, r.timestamp, r.photo]));
      const csv = rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
      downloadFile(csv, `time_records_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
      showToast('Export CSV เรียบร้อย');
    }

    function printReport(){
      document.getElementById('printDate').textContent = new Date().toLocaleDateString('th-TH');
      window.print();
    }

    function clearAllData(){
      if(!confirm('ล้าง employees + timeRecords ทั้งหมด?')) return;
      localStorage.removeItem('employees');
      localStorage.removeItem('timeRecords');
      employees=[]; timeRecords=[];
      renderAll(); updateStats();
      showToast('ล้างข้อมูลเรียบร้อย');
    }

    function downloadFile(content, filename, mime){
      const blob = new Blob([content],{type:mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }

    // ---------- Toast ----------
    let toastTimer;
    function showToast(text, isError=false){
      const el=document.getElementById('toast');
      el.textContent=text;
      el.className=`fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl text-white text-sm shadow-lg ${isError?'bg-rose-600':'bg-sky-700'}`;
      el.classList.remove('hidden');
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>el.classList.add('hidden'),2200);
    }
  </script>
</body>
</html>
