<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>หลังบ้าน — ระบบบันทึกเวลา (Firebase + Export + Filter)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
  <style>
    body{font-family:'Sarabun',sans-serif;background:linear-gradient(to bottom right,#e0f2fe,#bae6fd)}
    @media print{.no-print{display:none!important}}
  </style>
</head>
<body class="p-6 text-gray-800">
  <div class="max-w-6xl mx-auto bg-white/85 backdrop-blur rounded-3xl shadow-lg p-6 md:p-8">

    <header class="flex justify-between mb-6">
      <h1 class="text-2xl font-bold text-sky-900">หลังบ้าน — ระบบบันทึกเวลา (Firebase)</h1>
      <a href="index.html" class="no-print px-3 py-2 rounded-xl bg-white text-sky-700 border border-sky-100 shadow">หน้าบ้าน</a>
    </header>

    <!-- เพิ่มพนักงาน -->
    <section class="bg-white/95 border border-sky-100 rounded-2xl shadow p-5 mb-8">
      <h2 class="text-lg font-semibold text-sky-900 mb-4">เพิ่มพนักงาน</h2>
      <div class="grid md:grid-cols-4 gap-4">
        <input id="empName" class="px-3 py-2 border rounded-xl border-sky-200" placeholder="ชื่อ-สกุล">
        <input id="empSalary" type="number" min="0" class="px-3 py-2 border rounded-xl border-sky-200" placeholder="เงินเดือน/เดือน">
        <select id="empType" class="px-3 py-2 border rounded-xl border-sky-200">
          <option value="daily">ทดลองงาน (รายวัน)</option>
          <option value="monthly">ประจำ (รายเดือน + OT)</option>
        </select>
        <button onclick="addEmployee()" class="bg-sky-600 hover:bg-sky-700 text-white rounded-xl py-2">เพิ่มพนักงาน</button>
      </div>
    </section>

    <!-- ฟิลเตอร์เดือน/ปี -->
    <section class="bg-white border border-sky-100 rounded-2xl shadow p-5 mb-6">
      <h2 class="text-lg font-semibold text-sky-900 mb-4">เลือกเดือน / ปี สำหรับดูรายงาน</h2>
      <div class="grid md:grid-cols-4 gap-4">
        <select id="filterMonth" class="px-3 py-2 border rounded-xl border-sky-200"></select>
        <select id="filterYear" class="px-3 py-2 border rounded-xl border-sky-200"></select>
        <button onclick="loadEmployees()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-xl py-2">แสดงผล</button>
      </div>
    </section>

    <!-- ตารางพนักงาน -->
    <section class="bg-white border border-sky-100 rounded-2xl shadow p-5 mb-8">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold text-sky-900">พนักงานทั้งหมด</h2>
        <div class="no-print flex gap-2">
          <button onclick="exportMonthlyCSV()" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-xl text-sm">Export CSV</button>
          <button onclick="exportMonthlyExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-sm">Export Excel</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full table-auto">
          <thead>
            <tr class="bg-sky-50 text-sky-900">
              <th class="px-3 py-2">ชื่อ</th>
              <th class="px-3 py-2">ประเภท</th>
              <th class="px-3 py-2">เงินเดือน</th>
              <th class="px-3 py-2">เวรเดือนนี้</th>
              <th class="px-3 py-2">รายได้</th>
              <th class="px-3 py-2">ลบ</th>
            </tr>
          </thead>
          <tbody id="employeeTable"></tbody>
        </table>
      </div>
    </section>

    <!-- บันทึกเวลา -->
    <section class="bg-white border border-sky-100 rounded-2xl shadow p-5">
      <h2 class="text-lg font-semibold text-sky-900 mb-4">บันทึกเวลา (IN/OUT)</h2>
      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <select id="selectEmp" class="px-3 py-2 border rounded-xl border-sky-200"></select>
        <select id="selectType" class="px-3 py-2 border rounded-xl border-sky-200">
          <option value="in">เข้าเวร</option>
          <option value="out">ออกเวร</option>
        </select>
        <button onclick="recordTime()" class="bg-blue-600 hover:bg-blue-700 text-white rounded-xl py-2">บันทึกเวลา</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full table-auto">
          <thead><tr class="bg-sky-50 text-sky-900">
            <th class="px-3 py-2">ชื่อ</th>
            <th class="px-3 py-2">ประเภท</th>
            <th class="px-3 py-2">เวลา</th>
          </tr></thead>
          <tbody id="timeTable"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ====== FIREBASE CONFIG ======
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const SHIFT_HOURS = 12;

    // ====== ฟังก์ชันเริ่มต้น ======
    const monthNames = ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];
    const monthSelect = document.getElementById("filterMonth");
    const yearSelect = document.getElementById("filterYear");
    const currentYear = new Date().getFullYear();

    for (let i = 0; i < 12; i++) {
      const opt = document.createElement("option");
      opt.value = i+1;
      opt.text = monthNames[i];
      if (i === new Date().getMonth()) opt.selected = true;
      monthSelect.appendChild(opt);
    }
    for (let y = currentYear - 3; y <= currentYear + 1; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.text = y;
      if (y === currentYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }

    // ====== เพิ่มพนักงาน ======
    async function addEmployee(){
      const name = empName.value.trim();
      const salary = parseFloat(empSalary.value);
      const type = empType.value;
      if(!name || !salary){alert("กรุณากรอกข้อมูลให้ครบ");return;}
      await db.collection("employees").add({
        name, monthlySalary: salary, empType: type,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      empName.value=''; empSalary.value='';
      loadEmployees();
    }

    // ====== โหลดพนักงาน ======
    async function loadEmployees(){
      const month = parseInt(filterMonth.value);
      const year = parseInt(filterYear.value);
      const snap = await db.collection("employees").orderBy("createdAt","desc").get();
      const tbody = document.getElementById("employeeTable");
      const select = document.getElementById("selectEmp");
      tbody.innerHTML = ""; select.innerHTML = "<option value=''>เลือกพนักงาน</option>";

      for(const doc of snap.docs){
        const e = doc.data(); const id = doc.id;
        select.innerHTML += `<option value="${id}">${e.name}</option>`;
        const { totalShifts, totalEarn } = await calcSalary(id,e,month,year);
        const tr = document.createElement("tr");
        tr.className="border-b border-gray-100 hover:bg-sky-50";
        tr.innerHTML = `
          <td class="px-3 py-2">${e.name}</td>
          <td class="px-3 py-2">${e.empType==='daily'?'ทดลองงาน':'ประจำ'}</td>
          <td class="px-3 py-2">${e.monthlySalary.toLocaleString()} บาท</td>
          <td class="px-3 py-2">${totalShifts} เวร</td>
          <td class="px-3 py-2 font-semibold text-emerald-700">${totalEarn.toLocaleString('th-TH',{maximumFractionDigits:2})} บาท</td>
          <td class="px-3 py-2"><button onclick="delEmp('${id}')" class="bg-rose-600 hover:bg-rose-700 text-white px-3 py-1 rounded text-sm">ลบ</button></td>`;
        tbody.appendChild(tr);
      }
    }

    async function delEmp(id){
      if(confirm("ยืนยันการลบ?")){
        await db.collection("employees").doc(id).delete();
        const recs = await db.collection("timeRecords").where("employeeId","==",id).get();
        for(const r of recs.docs){await r.ref.delete();}
        loadEmployees(); loadTimeRecords();
      }
    }

    // ====== บันทึกเวลา ======
    async function recordTime(){
      const empId = selectEmp.value;
      const type = selectType.value;
      if(!empId){alert("เลือกพนักงานก่อน");return;}
      const emp = await db.collection("employees").doc(empId).get();
      if(!emp.exists) return alert("ไม่พบข้อมูลพนักงาน");
      await db.collection("timeRecords").add({
        employeeId: empId,
        employeeName: emp.data().name,
        type,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      loadTimeRecords(); loadEmployees();
    }

    async function loadTimeRecords(){
      const snap = await db.collection("timeRecords").orderBy("timestamp","desc").limit(50).get();
      const tbody = document.getElementById("timeTable");
      tbody.innerHTML="";
      for(const doc of snap.docs){
        const r=doc.data();
        const d=r.timestamp?.toDate?.()||new Date();
        const color=r.type==="in"?"text-green-600":"text-rose-600";
        tbody.innerHTML+=`
          <tr class="border-b border-gray-100">
            <td class="px-3 py-2">${r.employeeName}</td>
            <td class="px-3 py-2 font-semibold ${color}">${r.type==='in'?'เข้า':'ออก'}</td>
            <td class="px-3 py-2">${d.toLocaleString('th-TH')}</td>
          </tr>`;
      }
    }

    // ====== คำนวณเงินเดือน ======
    async function calcSalary(empId,e,month,year){
      const recs=await db.collection("timeRecords")
        .where("employeeId","==",empId)
        .orderBy("timestamp","asc").get();

      let totalHours=0,lastIn=null;
      for(const doc of recs.docs){
        const r=doc.data();
        if(!r.timestamp)continue;
        const t=r.timestamp.toDate();
        if(t.getMonth()+1!==month||t.getFullYear()!==year)continue;
        if(r.type==="in")lastIn=t;
        else if(r.type==="out"&&lastIn){
          const diff=Math.min((t-lastIn)/36e5,24);
          totalHours+=Math.min(diff,12);
          lastIn=null;
        }
      }
      const totalShifts=Math.floor(totalHours/12);
      const daysInMonth=new Date(year,month,0).getDate();
      const dailyRate=e.monthlySalary/daysInMonth;
      const totalEarn=dailyRate*totalShifts;
      return{totalShifts,totalEarn};
    }

    // ====== Export CSV / Excel ======
    async function exportMonthlyCSV(){
      const month=parseInt(filterMonth.value);
      const year=parseInt(filterYear.value);
      const snap=await db.collection("employees").get();
      const daysInMonth=new Date(year,month,0).getDate();
      let rows=[["ชื่อ","ประเภท","เงินเดือน","วันในเดือน","เวรทั้งหมด","รายได้"]];
      for(const doc of snap.docs){
        const e=doc.data();const {totalShifts,totalEarn}=await calcSalary(doc.id,e,month,year);
        rows.push([e.name,e.empType,e.monthlySalary,daysInMonth,totalShifts,totalEarn]);
      }
      const csv="\uFEFF"+rows.map(r=>r.join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=`summary-${year}-${month}.csv`;
      a.click();
    }

    async function exportMonthlyExcel(){
      const month=parseInt(filterMonth.value);
      const year=parseInt(filterYear.value);
      const snap=await db.collection("employees").get();
      const daysInMonth=new Date(year,month,0).getDate();
      let body="";
      for(const doc of snap.docs){
        const e=doc.data();const {totalShifts,totalEarn}=await calcSalary(doc.id,e,month,year);
        body+=`<tr><td>${e.name}</td><td>${e.empType}</td><td>${e.monthlySalary}</td><td>${daysInMonth}</td><td>${totalShifts}</td><td>${totalEarn.toFixed(2)}</td></tr>`;
      }
      const html=`<html><meta charset="UTF-8"><body><table border="1"><tr><th>ชื่อ</th><th>ประเภท</th><th>เงินเดือน</th><th>วันในเดือน</th><th>เวร</th><th>รายได้</th></tr>${body}</table></body></html>`;
      const blob=new Blob([html],{type:"application/vnd.ms-excel"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=`summary-${year}-${month}.xls`;
      a.click();
    }

    loadEmployees(); loadTimeRecords();
  </script>
</body>
</html>
